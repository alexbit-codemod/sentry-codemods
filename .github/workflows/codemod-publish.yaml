# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

# For more information see: https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/running-variations-of-jobs-in-a-workflow

name: Publish Codemod

on:
  push:
    tags:
      - "v*@*" # eg: v1.0.0@codemod-name
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to publish (format: v1.0.0@codemod-name)"
        required: true
        type: string

jobs:
  validate-and-publish:
    name: Validate and Publish Codemod
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.parse-tag.outputs.version }}
      codemod-name: ${{ steps.parse-tag.outputs.codemod-name }}
      codemod-path: ${{ steps.parse-tag.outputs.codemod-path }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Parse tag and extract metadata
        id: parse-tag
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_TAG: ${{ github.event.inputs.tag }}
          GITHUB_REF: ${{ github.ref }}
        run: |
          # Determine the tag based on trigger type
          if [[ "$EVENT_NAME" == "workflow_dispatch" ]]; then
            TAG="$INPUT_TAG"
            echo "Using manually provided tag: $TAG"
          else
            TAG="${GITHUB_REF#refs/tags/}"
            echo "Using pushed tag: $TAG"
          fi

          # Validate tag format
          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+@[a-zA-Z0-9_-]+$ ]]; then
            echo "❌ Invalid tag format: $TAG"
            echo "Expected format: v1.0.0@codemod-name"
            exit 1
          fi

          # Extract components
          VERSION="${TAG%@*}"      # Everything before @
          VERSION="${VERSION#v}"   # Remove v prefix
          CODEMOD_NAME="${TAG#*@}" # Everything after @
          CODEMOD_PATH="codemods/$CODEMOD_NAME"

          # Set outputs
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "codemod-name=$CODEMOD_NAME" >> $GITHUB_OUTPUT
          echo "codemod-path=$CODEMOD_PATH" >> $GITHUB_OUTPUT

      - name: Verify codemod directory
        env:
          CODEMOD_PATH: ${{ steps.parse-tag.outputs.codemod-path }}
        run: |
          if [[ ! -d "$CODEMOD_PATH" ]]; then
            echo "❌ Codemod directory not found: $CODEMOD_PATH"
            echo "Available directories in codemods/:"
            ls -lah codemods/ || echo "No codemods directory found"
            exit 1
          fi

          echo "✓ Found codemod directory: $CODEMOD_PATH"
          echo "Directory contents:"
          ls -lah "$CODEMOD_PATH"


      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install project dependencies
        run: |
          npm install --no-frozen-lockfile
          npm install -g codemod@latest

      # Run test before login to not waste time if it fails
      - name: Validate workflow
        working-directory: ${{ steps.parse-tag.outputs.codemod-path }}
        run: npx codemod@latest workflow validate --workflow workflow.yaml

      - name: Check if package.json exists
        id: check-package-json
        working-directory: ${{ steps.parse-tag.outputs.codemod-path }}
        run: |
          if [[ -f "package.json" ]]; then
            echo "has-package-json=true" >> $GITHUB_OUTPUT
          else
            echo "has-package-json=false" >> $GITHUB_OUTPUT
          fi

      - name: Run javascript ast-grep codemod Tests
        if: steps.check-package-json.outputs.has-package-json == 'true'
        working-directory: ${{ steps.parse-tag.outputs.codemod-path }}
        run: npm test

      - name: Authenticate with Codemod registry
        env:
          CODEMOD_API_KEY: ${{ secrets.CODEMOD_API_KEY }}
        run: npx codemod@latest login --api-key "$CODEMOD_API_KEY"

      - name: Publish codemod
        working-directory: ${{ steps.parse-tag.outputs.codemod-path }}
        run: npx codemod@latest publish

      - name: Create release summary
        env:
          CODEMOD_NAME: ${{ steps.parse-tag.outputs.codemod-name }}
          VERSION: ${{ steps.parse-tag.outputs.version }}
          TAG: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}
          TRIGGER: ${{ github.event_name == 'workflow_dispatch' && 'Manual' || 'Tag Push' }}
          ACTOR: ${{ github.triggering_actor }}
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # 🚀 Codemod Publication Summary

          **Codemod:** \`$CODEMOD_NAME\`
          **Version:** \`$VERSION\`
          **Tag:** \`$TAG\`
          **Trigger:** $TRIGGER by $ACTOR

          ✅ Codemod has been successfully published to the registry!
          EOF
